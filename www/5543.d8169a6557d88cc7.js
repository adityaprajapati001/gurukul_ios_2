"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[5543],{5346:(C,g,r)=>{r.d(g,{ez:()=>u,tP:()=>c});var c=function(n){return n.Documents="DOCUMENTS",n.Data="DATA",n.Library="LIBRARY",n.Cache="CACHE",n.External="EXTERNAL",n.ExternalStorage="EXTERNAL_STORAGE",n}(c||{}),u=function(n){return n.UTF8="utf8",n.ASCII="ascii",n.UTF16="utf16",n}(u||{})},1461:(C,g,r)=>{r.d(g,{fy:()=>d,tP:()=>u.tP});var c=r(2726),u=r(5346);const d=(0,c.fo)("Filesystem",{web:()=>r.e(4522).then(r.bind(r,4522)).then(e=>new e.FilesystemWeb)})},5543:(C,g,r)=>{r.d(g,{Y:()=>T});var c=r(5861),u=r(2726),d=r(1461),e=r(9212),n=r(3134),p=r(6593),f=r(4875),D=r(2783),s=r(7849),i=r(5175),m=r(6814);function S(a,O){if(1&a){const t=e.EpF();e.TgZ(0,"section",5)(1,"ion-button",6),e.NdJ("click",function(){e.CHM(t);const l=e.oxw();return e.KtG(l.sendScormData())}),e._uU(2,"Submit"),e.qZA()()}if(2&a){const t=e.oxw();e.xp6(),e.Q6J("disabled",!t.resumer)}}function w(a,O){if(1&a&&(e.TgZ(0,"div")(1,"h2"),e._uU(2,"Decoded HTML Value:"),e.qZA(),e._UZ(3,"div",7),e.qZA()),2&a){const t=e.oxw();e.xp6(3),e.Q6J("innerHTML",t.decodedHtmlValue,e.oJD)}}function h(a,O){if(1&a&&(e.TgZ(0,"div")(1,"h2"),e._uU(2,"Decoded HTML2 Value:"),e.qZA(),e._UZ(3,"div",7),e.qZA()),2&a){const t=e.oxw();e.xp6(3),e.Q6J("innerHTML",t.updateScore,e.oJD)}}function A(a,O){if(1&a&&(e.TgZ(0,"div")(1,"h2"),e._uU(2,"T Value:"),e.qZA(),e.TgZ(3,"div"),e._uU(4),e.qZA()()),2&a){const t=e.oxw();e.xp6(4),e.Oqu(t.tValue)}}function P(a,O){if(1&a&&(e.TgZ(0,"div")(1,"h2"),e._uU(2,"resumer Value:"),e.qZA(),e.TgZ(3,"div"),e._uU(4),e.qZA()()),2&a){const t=e.oxw();e.xp6(4),e.Oqu(t.resumer)}}let T=(()=>{class a{constructor(t,o,l,_,v,M,y,E){this.modalController=t,this.sanitizer=o,this.router=l,this.iframeMessageListenerService=_,this.scormApiService=v,this.authservice=M,this.cdr=y,this.loadingController=E,this.htmlData="",this.decodedHtmlValue=null,this.decodedHtml2Value=null,this.tValue=null,this.resumer=null,this.learnerName="",this.currentAttempts=1,this.userRealid=null}ngOnInit(){this.messageSubscription=this.iframeMessageListenerService.messages$.subscribe(t=>{if(console.log("Received value:",t),t&&t.type){switch(t.type){case"decodedHtml2":this.updateScore=t.value,console.log("Decoded HTML2 Value set to:",this.updateScore);break;case"t":this.tValue=t.value,console.log("T Value set to:",this.tValue);break;case"decodedHtml4":this.resumer=t.value,console.log("T Value set to:",this.resumer);break;default:console.warn("Unknown message type:",t.type)}this.cdr.detectChanges()}else console.error("Received value does not have a type:",t)}),this.loadStoryHtml(),this.GetAttempts(),this.getUser()}dismiss(){this.modalController.dismiss()}loadStoryHtml(){var t=this;return(0,c.Z)(function*(){const o="gurukul/unzip_files",l="gurukul/unzip_files/scormcontent";console.log("directoryPath",o);const _=yield t.readDirectory(o);console.log("Directory contents:",_),console.log("directoryPath2",l);const v=yield t.readDirectory(l);console.log("Directory contents2:",v);let M=_.find(E=>"index.html"===E.name);if(M||(M=v.find(E=>"index.html"===E.name)),M||(M=_.find(E=>"launcher.html"===E.name)),!M)return void console.error("HTML file (launcher.html or index.html) not found in the directories");console.log("htmlPath",M);const y=u.dV.convertFileSrc(M.uri);console.log("convertedUrl",y),t.iframeSrc=t.sanitizer.bypassSecurityTrustResourceUrl(y),console.log("iframeSrc",t.iframeSrc)})()}readFile(t){return(0,c.Z)(function*(){try{return(yield d.fy.readFile({path:t,directory:d.tP.External})).data}catch(o){return void console.error("Error reading file:",o)}})()}readDirectory(t){return(0,c.Z)(function*(){try{return(yield d.fy.readdir({path:t,directory:d.tP.External})).files}catch(o){return console.error("Error reading directory:",o),[]}})()}handleUpdateScore(){this.scormIdNew&&void 0!==this.updateScore?this.GetAttempts():console.error("Cannot proceed: scormIdNew or updateScore is not set.")}getUser(){const t=localStorage.getItem("username");console.log("Username from local storage:",t),t?this.authservice.getUserInfo(t).subscribe({next:o=>{console.log("User data:",o),o&&o.length>0?(this.userData=o,this.userRealid=o[0].id,console.log("User Real ID:",this.userRealid),this.loadCourseContent(this.scormIdNew)):console.error("No user data received or data array is empty")},error:o=>{console.error("Error fetching user info:",o)}}):console.error("Username is not set")}loadCourseContent(t){this.scormApiService.getScormsByCourseId(t).subscribe(o=>{console.log("response",o),o&&o.scorms&&o.scorms.length>0?(this.scormIdNew=o.scorms[4]?.id,this.maxAttempts=o.scorms[8]?.maxattempt,console.log("this.scormIdNew",this.scormIdNew),console.log("this.maxAttempts",this.maxAttempts),this.scormIdNew?this.getScormUserData():console.error("scormIdNew is undefined after loading course content.")):console.error("No scorms found in the response.")},o=>{console.error("Error fetching course content:",o)})}getScormUserData(){this.scormIdNew&&null!==this.userRealid?(console.log("Fetching SCORM user data for scormIdNew:",this.scormIdNew),this.scormApiService.getScormUserData(this.scormIdNew,this.currentAttempts).subscribe(t=>{this.scormData=t,this.scoid=t.data[1].scoid,console.log("SCORM Data:",this.scormData),console.log("scoid:",this.scoid),this.GetAttempts()},t=>{this.error="Failed to fetch SCORM data",console.error("Error fetching SCORM data:",t)})):console.error("scormIdNew or userRealid is not set. Cannot fetch SCORM user data.")}GetAttempts(){null!==this.userRealid?(console.log("GetAttempts_userRealid:",this.userRealid),this.scormApiService.getAttemptCount(this.scormIdNew,this.userRealid).subscribe(t=>{console.log("Attempt data:",t),t&&void 0!==t.attemptscount?(this.currentAttempts=t.attemptscount,console.log("Current attempts:",this.currentAttempts),this.currentAttempts<this.maxAttempts?(console.log("Attempt is within the allowed limit. Proceeding with submission."),this.sendScormData()):(console.log("Maximum attempts reached. Further submissions are not allowed."),this.error="Maximum attempts reached. Further submissions are not allowed.")):(console.error("Attempt count data is missing or malformed:",t),this.error="Error retrieving attempt count. Cannot proceed with submission.")},t=>{console.error("Error fetching SCORM attempts:",t),this.error="Error fetching SCORM attempts."})):console.error("UserRealid is not set. Cannot fetch attempts.")}sendScormData(){var t=this;return(0,c.Z)(function*(){const o=yield t.loadingController.create({message:"Loading...",duration:1e3});if(void 0===t.updateScore)return void console.error("Cannot send SCORM data: updateScore is not set.");const l=[{element:"cmi.core.score.raw",value:t.updateScore},{element:"cmi.core.score.min",value:"0"},{element:"cmi.core.score.max",value:"100"},{element:"cmi.core.lesson_status",value:t.tValue}];console.log("Tracks data to be sent:",l);const _=t.currentAttempts+1;console.log("Attempt count to be sent:",_),t.scormApiService.insertScormTracks2(l,t.scoid,_).subscribe(v=>{console.log("Success:",v),t.currentAttempts=_,t.currentAttempts>=t.maxAttempts&&console.log("Maximum attempts reached. Further submissions are not allowed.")},v=>{console.error("Error:",v)}),yield o.dismiss(),t.modalController?yield t.modalController.dismiss():console.log("ModalController is not available.")})()}ngOnDestroy(){this.messageSubscription&&this.messageSubscription.unsubscribe()}static#e=this.\u0275fac=function(o){return new(o||a)(e.Y36(n.IN),e.Y36(p.H7),e.Y36(f.F0),e.Y36(D.G),e.Y36(s.c),e.Y36(i.e),e.Y36(e.sBO),e.Y36(n.HT))};static#t=this.\u0275cmp=e.Xpm({type:a,selectors:[["app-iframe-modal"]],decls:13,vars:6,consts:[["slot","end"],["name","close-sharp","size","large",3,"click"],["width","100%","height","100%","frameborder","0",2,"border","none",3,"src"],["id","option-pane","class","option-pane","style","position: absolute; left: 0px; top: 0px; overflow: visible; transform-origin: center center; z-index: 10; width: 430px; height: 135px; transform: translate(0px, 565px) scale(1);",4,"ngIf"],[4,"ngIf"],["id","option-pane",1,"option-pane",2,"position","absolute","left","0px","top","0px","overflow","visible","transform-origin","center center","z-index","10","width","430px","height","135px","transform","translate(0px, 565px) scale(1)"],[3,"disabled","click"],[3,"innerHTML"]],template:function(o,l){1&o&&(e.TgZ(0,"ion-toolbar")(1,"ion-title"),e._uU(2,"Content"),e.qZA(),e.TgZ(3,"ion-buttons",0)(4,"ion-icon",1),e.NdJ("click",function(){return l.dismiss()}),e._uU(5,"Close"),e.qZA()()(),e.TgZ(6,"ion-content"),e._UZ(7,"iframe",2),e.YNc(8,S,3,1,"section",3)(9,w,4,1,"div",4)(10,h,4,1,"div",4)(11,A,5,1,"div",4)(12,P,5,1,"div",4),e.qZA()),2&o&&(e.xp6(7),e.Q6J("src",l.iframeSrc,e.uOi),e.xp6(),e.Q6J("ngIf",l.resumer),e.xp6(),e.Q6J("ngIf",l.decodedHtmlValue),e.xp6(),e.Q6J("ngIf",l.updateScore),e.xp6(),e.Q6J("ngIf",l.tValue),e.xp6(),e.Q6J("ngIf",l.resumer))},dependencies:[m.O5,n.YG,n.Sm,n.W2,n.gu,n.wd,n.sr],styles:[".iframe-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center;align-items:center;height:50%!important}.iframe-content[_ngcontent-%COMP%]{width:90%;height:50%!important}@media (min-width: 768px){.iframe-container[_ngcontent-%COMP%]{height:100%!important}}html[_ngcontent-%COMP%], body[_ngcontent-%COMP%]{height:50%!important;padding:0;margin:0}#app[_ngcontent-%COMP%]{height:50%!important;width:100%}.html[_ngcontent-%COMP%], .body[_ngcontent-%COMP%]{height:50%!important;padding:0;margin:0}.option-pane[_ngcontent-%COMP%]{background:#31373a;color:#fff;z-index:10;transition:none!important;margin-top:130px;text-align:center}"]})}return a})()},2783:(C,g,r)=>{r.d(g,{G:()=>d});var c=r(8645),u=r(9212);let d=(()=>{class e{constructor(){this.messageSubject=new c.x,this.messages$=this.messageSubject.asObservable(),this.messageListener=this.handleMessage.bind(this),window.addEventListener("message",this.messageListener,!1)}handleMessage(p){p.data.type&&p.data.value&&this.messageSubject.next({type:p.data.type,value:p.data.value})}ngOnDestroy(){window.removeEventListener("message",this.messageListener,!1)}static#e=this.\u0275fac=function(f){return new(f||e)};static#t=this.\u0275prov=u.Yz7({token:e,factory:e.\u0275fac,providedIn:"root"})}return e})()},7849:(C,g,r)=>{r.d(g,{c:()=>p});var c=r(9862),d=(r(553),r(9212)),e=r(2359);let p=(()=>{class f{constructor(s,i){this.http=s,this.tokenService=i,this.dataStorage={},this.moodleApiUrl="https://gurukul.skfin.in/webservice/rest/server.php",this.fcmToken="",this.token=this.tokenService.getToken(),console.log("token",this.token),this.initScormApi()}initScormApi(){window.API={LMSInitialize:s=>(console.log("LMSInitialize called with param:",s),console.log("dsfa",s),"true"),LMSFinish:s=>(console.log("LMSFinish called with param:",s),this.commitScormData(),"true"),LMSGetValue:s=>(console.log("LMSGetValue called with param:",s),this.dataStorage[s]||""),LMSSetValue:(s,i)=>(console.log("LMSSetValue called with param:",s,"and value:",i),this.dataStorage[s]=i,"true"),LMSCommit:s=>(console.log("LMSCommit called with param:",s),this.commitScormData(),"true"),LMSGetLastError:()=>"0",LMSGetErrorString:s=>"No error",LMSGetDiagnostic:s=>"No diagnostic information"}}commitScormData(){this.http.post(this.moodleApiUrl,{wstoken:this.token,wsfunction:"",moodlewsrestformat:"json",data:this.dataStorage},{headers:new c.WM({"Content-Type":"application/json"})}).subscribe(m=>{console.log("SCORM data successfully committed to Moodle:",m)},m=>{console.error("Error committing SCORM data to Moodle:",m)})}getPassingScore(){return window.SCORM2004_GetPassingScore()}setScore(s,i,m){return window.SCORM2004_SetScore(s,i,m)}getScore(){return window.SCORM2004_GetScore()}getScaledScore(){return window.SCORM2004_GetScaledScore()}insertScormTracks(s){const i=new c.WM({"Content-Type":"application/x-www-form-urlencoded"});let m=(new c.LE).set("wstoken",this.token).set("wsfunction","mod_scorm_insert_scorm_tracks").set("moodlewsrestformat","json"),S=new URLSearchParams;return S.set("scoid",this.scoid),S.set("attempt","6"),s.forEach((w,h)=>{S.set(`tracks[${h}][element]`,w.element),S.set(`tracks[${h}][value]`,w.value)}),this.http.post(this.moodleApiUrl,S.toString(),{headers:i,params:m})}insertScormTracks2(s,i,m){const S=new c.WM({"Content-Type":"application/x-www-form-urlencoded"});let w=(new c.LE).set("wstoken",this.token).set("wsfunction","mod_scorm_insert_scorm_tracks").set("moodlewsrestformat","json"),h=new URLSearchParams;return h.set("scoid",i),h.set("attempt",m.toString()),s.forEach((A,P)=>{h.set(`tracks[${P}][element]`,A.element),h.set(`tracks[${P}][value]`,A.value)}),this.http.post(this.moodleApiUrl,h.toString(),{headers:S,params:w})}getScormUserData(s,i){const m={wstoken:this.token,wsfunction:"mod_scorm_get_scorm_user_data",moodlewsrestformat:"json",scormid:s.toString(),attempt:i.toString()};return this.http.get(this.moodleApiUrl,{params:m})}getAttemptCount(s,i){return this.http.get(`${this.moodleApiUrl}?wstoken=${this.token}&wsfunction=mod_scorm_get_scorm_attempt_count&moodlewsrestformat=json&scormid=${s}&userid=${i}`)}getScormsByCourseId(s){return this.http.get(`${this.moodleApiUrl}?wstoken=${this.token}&wsfunction=mod_scorm_get_scorms_by_courses&moodlewsrestformat=json`)}static#e=this.\u0275fac=function(i){return new(i||f)(d.LFG(c.eN),d.LFG(e.B))};static#t=this.\u0275prov=d.Yz7({token:f,factory:f.\u0275fac,providedIn:"root"})}return f})()}}]);