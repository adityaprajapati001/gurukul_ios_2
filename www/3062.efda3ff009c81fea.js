"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[3062],{3062:(U,h,a)=>{a.r(h),a.d(h,{ChatScreenPageModule:()=>I});var g=a(6814),m=a(95),i=a(3134),u=a(4875),l=a(5861),t=a(9212),f=a(4940),p=a(5175);const v=["chatContainer"],C=["chatWindow"];function M(r,d){1&r&&(t.ynx(0),t.TgZ(1,"div",14)(2,"div",15),t._UZ(3,"ion-img",16),t.qZA(),t.TgZ(4,"p",17),t._uU(5,"No Messages were found"),t.qZA()(),t.BQk())}const T=(r,d)=>({sent:r,received:d});function x(r,d){if(1&r&&(t.ynx(0),t.TgZ(1,"div",18),t._UZ(2,"div",19)(3,"div",20),t.TgZ(4,"div",21),t._uU(5),t.ALo(6,"date"),t.qZA()(),t.BQk()),2&r){const n=d.$implicit,e=t.oxw();t.xp6(),t.Q6J("ngClass",t.WLB(6,T,(null==n?null:n.useridfrom)===e.loggedInUserId,(null==n?null:n.useridfrom)!==e.loggedInUserId)),t.xp6(2),t.Q6J("innerHTML",null==n?null:n.text,t.oJD),t.xp6(2),t.Oqu(t.xi3(6,3,null==n?null:n.timecreated,"shortTime"))}}const y=[{path:"",component:(()=>{class r{constructor(n,e,s,o){this.chatService=n,this.route=e,this.authService=s,this.actionSheetCtrl=o,this.message="",this.userIdTo=null,this.messages=[],this.useridfrom=0,this.loggedInUserId=null,this.loaded=!1,this.isMessageSent=!1}ngOnInit(){}ionViewDidEnter(){let n=localStorage.getItem("auth-user");this.loggedInUserId=JSON.parse(n)[0].id,this.userIdTo=this.route.snapshot.paramMap.get("userId"),this.loadFirstTimeConversations()}ngAfterViewChecked(){this.scrollToBottom()}scrollToBottom(){try{this.chatContainer.nativeElement.scrollTop=this.chatContainer.nativeElement.scrollHeight,this.content?.scrollToBottom(),this.isMessageSent=!1}catch(n){console.log(n)}}sendMessage(n){var e=this;return(0,l.Z)(function*(){try{if(console.log("messagemessage 1",n),e.messages.push({id:null,text:"<p>"+n+"</p>",timecreated:null,useridfrom:e.loggedInUserId}),!e.message)return;setTimeout(()=>e.scrollToBottom(),0),console.log("messagemessage 2",e.message);let o=e.message;console.log("tempMessage 2",e.message),e.message="",e.isMessageSent=!0,e.chatService.sendMessage(e.toUserDetails.id,encodeURIComponent(o)).subscribe(c=>{e.message=""})}catch(s){console.log(s)}})()}handleRefresh(n){this.loadFirstTimeConversations(n)}getConversations(n){var e=this;return(0,l.Z)(function*(){try{e.chatService.getConversations(e.loggedInUserId,e.userIdTo).subscribe(s=>{if(console.log("res",s),"Conversation does not exist"==s?.message)return e.messages=[],e.getToUserDetailsById(),e.loaded=!0,void(n&&n.target.complete());if(e.messages.push(s),console.log("res",s),e.toUserDetails=s.members[0],console.log("toUserDetails",e.toUserDetails),e.messages=s.messages.sort((o,c)=>o.timecreated>c.timecreated?-1:o.timecreated<c.timecreated?1:0),e.messages=e.messages.reverse(),e.messages.map(o=>{o.timecreated=new Date(1e3*o.timecreated)}),e.isMessageSent&&e.scrollToBottom(),e.useridfrom=e.messages[0].useridfrom,console.log("final messages",e.messages),0!=s.unreadcount){const o=e.messages.slice(-s.unreadcount);console.log("unreadMessages",o),e.markAllMessagesAsRead(o)}e.loaded=!0},s=>{console.error("Error fetching messages:",s)})}catch(s){console.log(s)}})()}loadFirstTimeConversations(n){var e=this;return(0,l.Z)(function*(){const s=yield e.chatService.loadFirstTimeConversations(e.loggedInUserId,e.userIdTo);if(console.log("res",s),"Conversation does not exist"==s?.message)return e.messages=[],e.getToUserDetailsById(),e.getConversations(),e.loaded=!0,void(n&&n.target.complete());e.messages.push(s),console.log("res",s),e.toUserDetails=s.members[0],console.log("toUserDetails",e.toUserDetails),e.messages=s.messages.sort((o,c)=>o.timecreated>c.timecreated?-1:o.timecreated<c.timecreated?1:0),e.messages=e.messages.reverse(),e.messages.map(o=>{o.timecreated=new Date(1e3*o.timecreated)}),e.loaded=!0,e.scrollToBottom(),e.getConversations()})()}ionViewWillLeave(){this.chatService.unsubscribeMessages()}getToUserDetailsById(){var n=this;return(0,l.Z)(function*(){try{const e=yield n.authService.getUserInfoByUserId(n.userIdTo).toPromise();console.log("to user details",e),n.toUserDetails=e[0]}catch(e){console.log(e)}})()}onDeleteMessage(n){var e=this;return(0,l.Z)(function*(){try{const s=yield e.chatService.deleteMessage(e.userIdTo,n).toPromise();console.log("delette chat res",s)}catch(s){console.log(s)}})()}markAllMessagesAsRead(n){var e=this;return(0,l.Z)(function*(){for(let s=0;s<n.length;s++){const o=n[s];yield e.markReadMessage(o.id)}})()}markReadMessage(n){var e=this;return(0,l.Z)(function*(){try{const s=yield e.chatService.markReadMessage(n).toPromise();console.log("mark read",s)}catch(s){console.log(s)}})()}presentActionSheet(n){var e=this;return(0,l.Z)(function*(){yield(yield e.actionSheetCtrl.create({header:"Actions",buttons:[{text:"Delete",role:"destructive",data:{action:"delete"},handler:()=>{console.log("Action 2 clicked",n),e.onDeleteMessage(n)}},{text:"Cancel",role:"cancel",data:{action:"cancel"}}]})).present()})()}static#e=this.\u0275fac=function(e){return new(e||r)(t.Y36(f.a),t.Y36(u.gz),t.Y36(p.e),t.Y36(i.BX))};static#t=this.\u0275cmp=t.Xpm({type:r,selectors:[["app-chat-screen"]],viewQuery:function(e,s){if(1&e&&(t.Gf(v,5),t.Gf(C,7),t.Gf(i.W2,5)),2&e){let o;t.iGM(o=t.CRH())&&(s.chatContainer=o.first),t.iGM(o=t.CRH())&&(s.chatWindow=o.first),t.iGM(o=t.CRH())&&(s.content=o.first)}},decls:18,vars:6,consts:[[1,"ion-no-border",3,"translucent"],["color","primary","slot","start","defaultHref",""],["slot","start",1,"header","p-2"],[3,"fullscreen"],[4,"ngIf"],["size","12"],[1,"chat-container"],["chatContainer",""],[4,"ngFor","ngForOf"],[1,"footer","ion-no-padding"],[1,"chat_ft","ion-no-padding"],[1,"col-12","d-flex","align-items-center","justify-content-evenly","px-2","py-3"],["placeholder","Type a message",1,"col-10","msg","ps-3","p-1",3,"ngModel","ngModelChange"],["src","assets/img/send.png",3,"click"],[1,"col-12","inbox","text-center"],[1,"d-flex","align-items-center","justify-content-center","mb-5"],["src","assets/img/chat_grey.png"],[1,"inbox_p"],[1,"message",3,"ngClass"],[1,"tail"],[3,"innerHTML"],[1,"time"]],template:function(e,s){1&e&&(t.TgZ(0,"ion-header",0)(1,"ion-toolbar"),t._UZ(2,"ion-back-button",1),t.TgZ(3,"ion-label",2)(4,"b"),t._uU(5),t.qZA()()()(),t.TgZ(6,"ion-content",3),t.YNc(7,M,6,0,"ng-container",4),t.TgZ(8,"ion-row")(9,"ion-col",5)(10,"div",6,7),t.YNc(12,x,7,9,"ng-container",8),t.qZA()()()(),t.TgZ(13,"ion-footer",9)(14,"ion-toolbar",10)(15,"div",11)(16,"ion-input",12),t.NdJ("ngModelChange",function(c){return s.message=c}),t.qZA(),t.TgZ(17,"ion-img",13),t.NdJ("click",function(){return s.sendMessage(s.message)}),t.qZA()()()()),2&e&&(t.Q6J("translucent",!0),t.xp6(5),t.Oqu(null==s.toUserDetails?null:s.toUserDetails.fullname),t.xp6(),t.Q6J("fullscreen",!0),t.xp6(),t.Q6J("ngIf",0==s.messages.length&&s.loaded),t.xp6(5),t.Q6J("ngForOf",s.messages),t.xp6(4),t.Q6J("ngModel",s.message))},dependencies:[g.mk,g.sg,g.O5,m.JJ,m.On,i.wI,i.W2,i.fr,i.Gu,i.Xz,i.pK,i.Q$,i.Nd,i.sr,i.j9,i.oU,g.uU],styles:[".inbox[_ngcontent-%COMP%]{margin-top:50%}.inbox_p[_ngcontent-%COMP%]{color:#000;font-family:Inter,sans-serif;font-size:20px;font-weight:500}.chat-container[_ngcontent-%COMP%]{width:100%;max-width:400px;margin:20px auto;font-family:Arial,sans-serif}.message[_ngcontent-%COMP%]{margin-bottom:10px;position:relative;padding:10px;border-radius:7px;max-width:70%;min-height:60px}.sent[_ngcontent-%COMP%]{background-color:#f2f2f2;color:#000;align-self:flex-end;margin-left:auto;margin-right:6px}.received[_ngcontent-%COMP%]{background-color:#3553a1;color:#fff;align-self:flex-start;margin-right:auto;margin-left:4px}.tail[_ngcontent-%COMP%]{position:absolute;width:0;height:0;border-top:10px solid transparent}.sent[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{right:-10px;border-left:10px solid #f2f2f2}.received[_ngcontent-%COMP%]   .tail[_ngcontent-%COMP%]{left:-10px;border-right:10px solid #3553A1}.time[_ngcontent-%COMP%]{font-size:12px;margin-top:-14px;float:right}"]})}return r})()}];let S=(()=>{class r{static#e=this.\u0275fac=function(e){return new(e||r)};static#t=this.\u0275mod=t.oAB({type:r});static#s=this.\u0275inj=t.cJS({imports:[u.Bz.forChild(y),u.Bz]})}return r})(),I=(()=>{class r{static#e=this.\u0275fac=function(e){return new(e||r)};static#t=this.\u0275mod=t.oAB({type:r});static#s=this.\u0275inj=t.cJS({imports:[g.ez,m.u5,i.Pc,S]})}return r})()}}]);